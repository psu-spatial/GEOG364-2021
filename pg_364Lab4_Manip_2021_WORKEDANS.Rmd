---
title: "GEOG 364 Lab 4"
author: "TA WORKED ANSWERS"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: yes
    number_sections: yes
    theme: sandstone
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Load Libraries

```{r, message=FALSE, warning=FALSE}
library(knitr) 
library(tidyverse)
library(sf)
library(sp)
library(tmap)
library(skimr)
library(rnaturalearth)
library(readxl) 
library(USAboundaries)
```

# Markdown

<br>

[***The difference between pattern and process***]{.ul}

[*Patterns*]{.ul}

A pattern is a regularity that can be observed in nature. Patterns can also be observed in human made features or in abstract ideas. It characterizes the spatial arrangement of features in relation to each other. Patterns in nature are generated by processes that occur in a system. Systems are therefore characterized by the existing patterns which are more often indicative of the processes happening in that system. Patterns can be spatial or temporal, dynamic or static. Spatial patterns in nature are exhibited by recurring or repeating of features and their relationship across space.

<br>

[*Processes*]{.ul}

A process is an operation/mechanism that results in changes in a system. Different processes generate distinctive patterns. An example is a wildfire that creates patches of burnt and unburnt areas on a landscape. By observing the generated patterns it is often possible to determine the processes that created them. However, the pattern-process relationship is often reciprocal, meaning that the generated patterns can influence future processes as well, leading to creation of other distinctive patterns.

<br>
<br>

[***Markdown edits***]{.ul}

***Read in frost data and inserting inline code***

```{r,echo=FALSE,eval=FALSE}
frost <- read_excel("frostdata.xlsx")
```

```{r,echo=FALSE,include=FALSE}
frost   <- readxl::read_excel("pg_364Data_1frostday.xlsx")
```

```{r,echo=FALSE}
frost.elev <- mean(frost$Elevation)
frost.nrow <- nrow(frost)
frost.ncol <- ncol(frost)
```

In lab 2, we read in a dataset called frostdata.xlsx. The data has `r frost.nrow` rows and `r frost.ncol` columns. The mean of the Elevation column is `r frost.elev` feet.

<br>

***Rounding off elevation values***

In lab 2, we read in a dataset called frostdata.xlsx. The data has `r frost.nrow` rows and `r frost.ncol` columns. The mean of the Elevation column is `r round(frost.elev,2)` feet.

<br>

***Describing Z score and inserting equations***

The Z-score tells us the number of standard deviations a value is above or below the mean.

It is calculated using the following equation:


```{r, L4Worked_Eqn1, echo=FALSE}
knitr::include_graphics('pg_364Lab4_Manip_2021_WORKEDANS_Eqn1.png')
```


Where $z$ is the z-score, $x_i$ is the data point in question, $\mu$ is the mean, and $\sigma$ is the standard deviation.

<br>
<br>

# Ozone and MAUP

***Reading ozone data file***

```{r, eval=FALSE}
ozone <- read.csv('ozone.csv')
```

```{r, include=FALSE}
ozone   <- read.csv("pg_364Data_4Ozone.csv")
```

<br>
<br>

## **Summary statistics**

***Ozone pollution and health. What's the big deal?***

-   Ground level ozone is generated when oxides of nitrogen (NOx) and volatile organic compounds (VOCs) react chemically in sunlight. During hot days when sunlight is abundant, ozone pollution is higher. These reactants come from pollutant emissions of cars, power plants, industrial boilers, refineries, and chemical plants; or even from paints, cleaners, solvents, and motorized lawn equipment. It is therefore more likely to find higher levels of ground level ozone near cities than in rural areas. However, wind can transport this ozone to other regions outside of the city

-   Ozone pollution is dangerous because it can cause serious health problems related difficulties in breathing, coughing and shortness of breath. It can also lead to damage of airways, chronic bronchitis and asthma among other illnesses.

-   In addition, ozone pollution can also damage vegetation leading to reduced growth, more diseases and mass die-offs in crops

***About the data/study***

***About the ozone dataset***

-   Unit of observation for this data

The unit of observation is a location or site where measurements of ground level ozone were made.


<br>

-   Is the data marked? If so, what are the marks? (e.g. what columns are there)

The data is marked. In addition to the latitude and longitude of the locations, we have the ozone measurement, the population density, and the names of the sites. The following are all the columns in the dataset:

```{r, echo=FALSE}
names(ozone)
```

-   How many observations are there? (e.g. how many rows)

There are `r nrow(ozone)` observations in the dataset.

<br>

-   What are the summary statistics - do they look reasonable?

The summary statistics for each of the variables in the dataset at shown in the table below. They all look reasonable.

```{r}
summary(ozone)
```

<br>

-   What does the histograms of the ozone column look like (remember to get the exact column name you can use the command names(ozonedata))?

```{r}
p <- ggplot(ozone, aes(OZONE_1000PPB)) + 
  geom_histogram(bins=10, color = "purple", fill = "yellow") +
    xlab("Ozone levels (1000 parts per billion)")+
  ylab("Number of locations/sites")+
  theme(
    axis.title.x = element_text(color="black", size=14, face="bold"),
    axis.text=element_text(size=14, face="bold"),
axis.title.y = element_text(color="black", size=14, face="bold")
  )
p
```

A histogram of ozone values is slightly skewed to the left such that we have fewer very high ozone measurements and less very low ozone measurements. The histograms shows that most locations have between 15000 and 50000 parts per billion ozone levels, a few locations have very high (close to 80000 parts per billion) ozone levels.


<br>


-   Use a QQ-Norm to plot to assess if the data in the ozone column is normally distributed. (hint, see the QQQplot here <http://www.sthda.com/english/wiki/normality-test-in-r> if you want a prettier one)

```{r}
qqnorm(ozone$OZONE_1000PPB)
qqline(ozone$OZONE_1000PPB)
```

The plot shows that ozone data is not normally distributed. QQ-Norm plot confirms what is shown on the histogram. Locations with high ozone levels have levels higher than would be expected for normally distributed data.


<br>

-   BONUS! Conduct and interpret in full sentences, a Wilks-Shapiro test to assess if the data is normal (hint: tutorial: <http://www.sthda.com/english/wiki/normality-test-in-r>)

```{r}
shapiro.test(ozone$OZONE_1000PPB)
```

H_0_ : The underlying distribution this data is sampled from is a normal distribution

H_1_ : Given our observed W statistic, we suggest the underlying distribution this data is sampled from is unlikely to be Normal

We conduct a Wilks Shapiro test, which suggests that with a W statistic of 0.94713 (this depends on sample size), there is less than a 1x10~-10~ probability of seeing this result if the underlying distribution really was normal..

This is 

The p-value is \<0.05 indicating that the distribution of the data are significantly different from that of a normal distribution. The data is not normally distributed.

***Research hypothesis:*** From what you (now) know about ozone, how do you expect the pattern of ozone to be distributed over California? What influences it and what are confounding factors?

[Pattern of distribution:]{.ul} Based on my current knowledge of the sources of ground level ozone, I would expect that locations that are in cities or near cities and industries will have high levels of ozone.

[What influences it?]{.ul} Pollutant emissions from automotives and industries as well as sunlight.

[What are confounding factors?]{.ul} Ozone levels are influenced by a number of factors such as temperature, driving patterns, wind speed and direction. Temperature can be an important confounding factor in ozone measurements. High temperature facilitates the chemical reactions that lead to production of ozone. High temperature can also influence people's level of comfort and willingness to go outdoors and drive around. When it is too hot, people may shy away and limit driving leading to less vehicle related pollution and lower ozone levels. Again ozone is a gas and therefore it moves with wind. The speed and direction of wind will influence ozone levels and the distribution across California. 

## Spatial mapping

```{r}
ozone.sf <- st_as_sf(ozone,coords=c("LONGITUDE","LATITUDE"),crs=4326)
```

```{r}
plot(st_geometry(ozone.sf))
```

```{r}
plot(ozone.sf)
```

```{r}
plot(ozone$LONGITUDE,ozone$LATITUDE)
```

**A map of ozone levels:** Does the distribution agree with what you expected?

```{r}
tmap_mode("view")
qtm(ozone.sf,dots.col="OZONE_1000PPB")
```

The distribution does not agree with what I expected. The map shows that most of the locations that are in cities have the lowest ozone levels and many locations that have some of the highest ozone levels are in rural areas.

It is likely that the pattern we now observe has been influenced by some of the confounding factors such as wind speed and direction. The general wind direction in California is west to east. It is possible that wind blows away ozone from the urban areas toward the eastern less populated areas. The ozone then gets trapped behind the mountain ranges leading high levels in those rural areas.

There is also a theory that specific pollutants from vehicle help to dissipate ground level ozone. In the absence of such pollutants, ozone levels keep rising. because of low traffic volume in rural California, these pollutants are not available to break down ozone.


***Add county borders***

```{r}
ca_counties.sf <- us_boundaries(states="CA", type = "county")

plot(st_geometry(ca_counties.sf))
plot(st_geometry(ozone.sf),add=TRUE,col="red",pch=16,cex=.5)
```

***Add congressional borders***

```{r}
ca_congress.sf <- us_boundaries(states="CA", type = "congressional")

plot(st_geometry(ca_congress.sf))
plot(st_geometry(ozone.sf),add=TRUE,col="red",pch=16,cex=.5)
```

***A map of ozone levels over county borders***

```{r}
# use the command tmaptools::palette_explorer() in the console to choose a more appropriate palette (needs shinyjs package)
tmap_mode("view")
tm_shape(ca_counties.sf) + tm_borders() +
  tm_shape(ozone.sf) +
  tm_dots(col="OZONE_1000PPB", palette = "YlOrRd", 
          title="Ozone levels (1000 parts per billion)", size=0.04) +
  tm_legend(legend.outside=TRUE)+
  tm_basemap(leaflet::providers$OpenStreetMap.DE)
```

## Spatial wrangling

***Exploring the columns: Ozone data***

```{r}
# First, look at the ozone column names to understand that table
head(ozone.sf)
```

***Exploring the columns: Congressional districts***

```{r}
#the congressional district column is cd115fp
head(ca_congress.sf)
```

**Summarize our data across polygons: [Congressional districts level]{.ul}**

```{r}
#-----------------------------------------------------------
# We are first going to stick these together to make a table where I know the 
# zone every point is in. 
#-----------------------------------------------------------
joineddata  <- st_join(ozone.sf, ca_congress.sf)

#-----------------------------------------------------------
# Now I'm going to do a load of statistics on the joined data
#-----------------------------------------------------------

# How many observations in each congressional district
number.obs    <-  joineddata %>%  
                   group_by(cd115fp) %>% 
                   summarize(number.obs = length(cd115fp)) %>% 
                   select(number.obs)

# Mean population density in each congressional district
mean_POPULATION_DENSITY <-   joineddata %>%  
                             group_by(cd115fp) %>% 
                             summarize(mean_POPULATION_DENSITY = mean(POPULATION_DENSITY)) %>% 
                             select(mean_POPULATION_DENSITY)
                   
# Max population density in each congressional district
max_POPULATION_DENSITY <-    joineddata %>%  
                             group_by(cd115fp) %>% 
                             summarize(max_POPULATION_DENSITY = max(POPULATION_DENSITY)) %>% 
                             select(max_POPULATION_DENSITY)

# Mean ozone levels in each congressional district
mean_OZONE_1000PPB    <-   joineddata %>%  
                           group_by(cd115fp) %>% 
                           summarize(mean_OZONE_1000PPB = mean(OZONE_1000PPB)) %>% 
                           select(mean_OZONE_1000PPB)

#-----------------------------------------------------------
# And finally, merge them with the congressional polygon variable
# I'm first making a copy so that I don't mess anything up
#-----------------------------------------------------------
ca_congress.data.sf <- ca_congress.sf

ca_congress.data.sf <- st_join(ca_congress.data.sf, number.obs)
ca_congress.data.sf <- st_join(ca_congress.data.sf, mean_POPULATION_DENSITY)
ca_congress.data.sf <- st_join(ca_congress.data.sf, max_POPULATION_DENSITY)
ca_congress.data.sf <- st_join(ca_congress.data.sf, mean_OZONE_1000PPB)

#-----------------------------------------------------------
# And test plot, note I'm now plotting ca_congress.data.sf!
#-----------------------------------------------------------
plot1 <- qtm(ca_congress.data.sf,fill ="mean_POPULATION_DENSITY")
plot2 <- qtm(ca_congress.data.sf,fill ="max_POPULATION_DENSITY")
tmap_arrange(plot1,plot2)
```

```{r}
plot3 <- qtm(ca_congress.data.sf,fill ="number.obs")
plot4 <- qtm(ca_congress.data.sf,fill ="mean_OZONE_1000PPB")
tmap_arrange(plot3,plot4)
```

```{r}
# And finally take a look at the column names of the new sf variable - you can see
# our calculations have been added in
#-----------------------------------------------------------
head(ca_congress.data.sf)
```

**Summarize our data across polygons: [County level]{.ul}**

```{r}
#-----------------------------------------------------------
# We are first going to stick these together to make a table where I know the 
# zone every point is in. 
#-----------------------------------------------------------
joineddata  <- st_join(ozone.sf, ca_counties.sf)

#-----------------------------------------------------------
# Now I'm going to do a load of statistics on the joined data
#-----------------------------------------------------------

# How many observations in each congressional district
number.obs    <-  joineddata %>%  
                   group_by(geoid) %>% 
                   summarize(number.obs = length(geoid)) %>% 
                   select(number.obs)

# Mean population density in each congressional district
mean_POPULATION_DENSITY <-   joineddata %>%  
                             group_by(geoid) %>% 
                             summarize(mean_POPULATION_DENSITY = mean(POPULATION_DENSITY)) %>% 
                             select(mean_POPULATION_DENSITY)
                   
# Max population density in each congressional district
max_POPULATION_DENSITY <-    joineddata %>%  
                             group_by(geoid) %>% 
                             summarize(max_POPULATION_DENSITY = max(POPULATION_DENSITY)) %>% 
                             select(max_POPULATION_DENSITY)

# Max population density in each congressional district
mean_OZONE_1000PPB    <-   joineddata %>%  
                           group_by(geoid) %>% 
                           summarize(mean_OZONE_1000PPB = mean(OZONE_1000PPB)) %>% 
                           dplyr::select(mean_OZONE_1000PPB)

# Max population density in each congressional district
max_OZONE_1000PPB    <-   joineddata %>%  
                           group_by(geoid) %>% 
                           summarize(max_OZONE_1000PPB = max(OZONE_1000PPB)) %>% 
                           dplyr::select(max_OZONE_1000PPB)
#-----------------------------------------------------------
# And finally, merge them with the congressional polygon variable
# I'm first making a copy so that I don't mess anything up
#-----------------------------------------------------------
ca_counties.data.sf <- ca_counties.sf

ca_counties.data.sf <- st_join(ca_counties.data.sf, number.obs)
ca_counties.data.sf <- st_join(ca_counties.data.sf, mean_POPULATION_DENSITY)
ca_counties.data.sf <- st_join(ca_counties.data.sf, max_POPULATION_DENSITY)
ca_counties.data.sf <- st_join(ca_counties.data.sf, mean_OZONE_1000PPB)
ca_counties.data.sf <- st_join(ca_counties.data.sf, max_OZONE_1000PPB)
#-----------------------------------------------------------
# And test plot, note I'm now plotting ca_counties.data.sf!
#-----------------------------------------------------------
plot1 <- qtm(ca_counties.data.sf,fill ="mean_POPULATION_DENSITY")
plot2 <- qtm(ca_counties.data.sf,fill ="max_POPULATION_DENSITY")
tmap_arrange(plot1,plot2)
```

```{r}
plot3 <- qtm(ca_counties.data.sf,fill ="number.obs")
plot4 <- qtm(ca_counties.data.sf,fill ="mean_OZONE_1000PPB")
tmap_arrange(plot3,plot4)
```

```{r}
# And finally take a look at the column names of the new sf variable - you can see
# our calculations have been added in
#-----------------------------------------------------------
head(ca_counties.data.sf)
```

***BONUS: a plot the maximum ozone level in each county in California***

```{r}
count_maxOZone <- tm_shape(ca_counties.data.sf)+
  tm_fill("max_OZONE_1000PPB", title="Max ozone levels")+
  tm_layout("")
count_maxOZone
```

***Side by side maps of the county aggregated mean Ozone levels, and another for the congressional district aggregated mean Ozone levels***

```{r,echo=FALSE, results='hide',fig.show='hide'}
cong_meanZone <- qtm(ca_congress.data.sf,fill ="mean_OZONE_1000PPB", 
                     title="Congressional district aggregated mean Ozone levels",
                     ca_congress.data.sf.style = "Ozone levels")
coun_meanZone <- qtm(ca_counties.data.sf,fill ="mean_OZONE_1000PPB", 
                     title="County aggregated mean Ozone levels",
                     ca_county.data.sf.style = "Ozone levels")
tmap_arrange(cong_meanZone,coun_meanZone)
```

```{r}
library(tmap)
cong_meanZone <- tm_shape(ca_congress.data.sf)+
  tm_fill("mean_OZONE_1000PPB", title="Mean ozone levels - Congressinal districts")+
  tm_layout("")

coun_meanZone <- tm_shape(ca_counties.data.sf)+
  tm_fill("mean_OZONE_1000PPB", title="Mean ozone levels - Counties")+
  tm_layout("")

tmap_arrange(cong_meanZone,coun_meanZone)
```

**tmap options:** I edited legend title to make it easier to differentiate between county and congressional level maps.

**MAUP**

The modifiable areal unit problem (MAUP) is a statistical bias that occurs when point data is aggregated. The bias may be caused by choice of scale of aggregation or the choice of zones of aggregation. The scale effect occurs when different levels of aggregation result in different summary statistics. Depending on the spatial distribution of points across a study areas, choosing large or small aggregation units will result in different statistics. The zone effect occurs when the shape of the aggregation units affects the points that are included leading to varying statistics.

These two biases are illustrated with the ozone data above. At the point level, points show exact measurements for the specific locations. However, these points are samples and therefore not all areas in California are represented. Aggregating the point data to county of congressional boundaries ensures that we can describe ozone levels for all of California although with a lot of biases and assumptions. We can observe the impact of this generalization in the way high and low ozone levels are distributed. At the congressional level, there is a lot of generalization over larger areas which gives the impression that the whole area has high ozone levels. Yet, such large areas have very low point density and only a few high ozone level points. At the county level, the aggregation units are smaller, and we begin to see how much generalization had occurred at the congressional level.

**Raster to vector**

The density of points is not even across California. Some parts of California have high density of points and are therefore better represented than other areas. Aggregating such points leads to bias because depending on the level and zone of aggregation units, some units may be represented by only a few points that would most likely not reflect the actual situation for the area. Generalizations for large areas are made made based on a limited sample leading to biased summary statistics and wrong conclusions.

**Tobler's law**

Complete spatial randomness (CSR) occurs when a point pattern is generated by an independent random process leading randomly distributed data.

Tobler's law is the first law of geography according to [Waldo Tobler]{.ul} which state that **"everything is related to everything else, but near things are more related than distant things."** It is the foundation concept that defined spatial dependence and spatial autocorrelation. When similar things cluster together, we have positive spatial autocorrelation. Negative spatial autocorrelation occurs when values are surrounded by different values. Zero autocorrelation occurs when we have complete spatial randomness and values are randomly distributed. 
The ozone data appears to have positive spatial autocorrelation and the point level because high ozone points tend to cluster or occur close together. 




